#!/usr/bin/env bash

oper=$1
jarfile='/usr/share/cloudstack-common/lib/cloudstack-utils.jar'
process='/etc/default/cloudstack-management'
securityjarfile='/usr/share/cloudstack-common/lib/'
scriptpath='/usr/share/cloudstack-common/scripts'

function afterStarted()
{
    sed -i "/BOOTSTRAP_CLASS=org.apache.cloudstack.ServerDaemon/d" $process
    echo "BOOTSTRAP_CLASS=org.apache.cloudstack.ServerDaemon" >> $process
}

function beforeStart()
{
    sed -i "/BOOTSTRAP_CLASS=org.apache.cloudstack.ServerDaemon/d" /etc/default/cloudstack-management
    # Enter the password required when creating kek
    echo "::::: Enter the required password when generating a key encryption key(KEK).(more than 4 characters) :::::"

    while :
    do
        echo -n "Password : "
        read -s kek_pass
        echo " "

        if [ -z $kek_pass ] || [ ${#kek_pass} -lt 4 ]
        then
            echo "Please check your password again.(more than 4 characters)"
        else
            break
        fi
    done

    # secretkey=$(openssl enc -aria-256-cbc -a -d -pbkdf2 -k $kek_pass -saltlen 16 -md sha2-256 -iter 100000 -in key.enc)
    # encPassword=$(java -classpath $jarfile com.cloud.utils.crypt.EncryptionCLI -i $kek_pass -p $secretkey | sed 's/\//\\\//g')
    # echo "BOOTSTRAP_CLASS=org.apache.cloudstack.ServerDaemon "$encPassword $secretkey >> $process

    kek_pass=$(echo $kek_pass | base64)
    echo "BOOTSTRAP_CLASS=org.apache.cloudstack.ServerDaemon "$kek_pass >> $process
}

function securityCheck()
{
    kek_pass=$(echo $kek_pass | base64 --decode) > /dev/null 2>&1
    key=$(openssl enc -aria-256-cbc -a -d -pbkdf2 -k $kek_pass -saltlen 16 -md sha256 -iter 100000 -in /etc/cloudstack/management/key.enc) > /dev/null 2>&1
    DB_FILE="/etc/cloudstack/management/db.properties"
    test=$(cat $DB_FILE | grep 'db.cloud.password' | wc -l) > /dev/null 2>&1
    if [ ! "$test" -eq 0 ]; then
        openssl enc -aes-256-cbc -d -K $key -pass pass:$kek_pass -saltlen 16 -md sha256 -iter 100000 -in /etc/cloudstack/management/db.properties.enc -out /etc/cloudstack/management/db.properties
        DbCloudEncPassword=$(sed '/^\#/d' $DB_FILE | grep 'db.cloud.password'  | tail -n 1 | cut -d "=" -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'i | sed 's/^ENC(\(.*\))/\1/')
        encVersion=$(sed '/^\#/d' $DB_FILE | grep 'db.cloud.encryptor.version'  | tail -n 1 | cut -d "=" -f2-)
        DATABASE_PASSWD=$(java -classpath $jarfile com.cloud.utils.crypt.EncryptionCLI -d -i "$DbCloudEncPassword" -p "$key" $encVersion)
        mysql --user=root --password=$DATABASE_PASSWD -e "use cloud; SET GLOBAL foreign_key_checks=0;" > /dev/null 2>&1
        mysql --user=root --password=$DATABASE_PASSWD -e "use cloud; CREATE TABLE IF NOT EXISTS security_check (id bigint unsigned NOT NULL AUTO_INCREMENT, mshost_id bigint unsigned NOT NULL COMMENT 'the ID of the mshost', check_result tinyint(1) default 1 not null comment 'check executions success or failure', check_date datetime DEFAULT NULL COMMENT 'the last security check time', check_failed_list mediumtext null, type varchar(32) null, PRIMARY KEY (id), KEY i_security_checks__mshost_id (mshost_id), CONSTRAINT fk_security_checks__mshost_id FOREIGN KEY (mshost_id) REFERENCES mshost (id) ON DELETE CASCADE) ENGINE=InnoDB CHARSET=utf8mb3;" > /dev/null 2>&1
        HOST_IP=$(hostname -i)
        UUID=$(cat /proc/sys/kernel/random/uuid)
        mysql --user=root --password=$DATABASE_PASSWD -e "use cloud; INSERT INTO event (uuid, type, state, description, user_id, account_id, domain_id, resource_id, created, level, start_id, archived, display, client_ip) VALUES ('$UUID', 'SECURITY.CHECK', 'Started', 'Running security check on management server when operating the product.', '2', '2', '1', '0', DATE_SUB(NOW(), INTERVAL 9 HOUR), 'INFO', '0', '0', '1', '$HOST_IP');" > /dev/null 2>&1
        # utils 55 count
        utils_cmd=${securityjarfile}junit-4.13.2.jar:${securityjarfile}hamcrest-all-1.3.jar:${securityjarfile}cloudstack-utils-test.jar:${securityjarfile}cloudstack-utils.jar:${securityjarfile}commons-lang-2.6.jar:${securityjarfile}commons-io-2.8.0.jar:${securityjarfile}bcprov-jdk15on-1.70.jar:${securityjarfile}guava-testlib-18.0.jar:${securityjarfile}guava-31.1-jre.jar:${securityjarfile}httpcore-4.4.16.jar:${securityjarfile}httpclient-4.5.14.jar:${securityjarfile}mockito-core-3.12.4.jar:${securityjarfile}byte-buddy-1.10.5.jar:${securityjarfile}byte-buddy-agent-1.10.5.jar:${securityjarfile}commons-validator-1.6.jar:${securityjarfile}commons-net-3.7.2.jar:${securityjarfile}commons-lang3-3.11.jar:${securityjarfile}java-ipv6-0.17.jar:${securityjarfile}objenesis-3.2.jar:${securityjarfile}commons-collections4-4.4.jar:${securityjarfile}commons-collections-3.2.2.jar:${securityjarfile}spring-core-5.3.26.jar:${securityjarfile}commons-logging-1.2.jar:${securityjarfile}gson-1.7.2.jar:${securityjarfile}jackson-core-2.13.3.jar:${securityjarfile}jackson-databind-2.13.3.jar:${securityjarfile}jackson-annotations-2.13.3.jar:${securityjarfile}trilead-ssh2-1.0.0-build217.jar:${securityjarfile}joda-time-2.12.5.jar:${securityjarfile}jsch-0.1.55.jar:${securityjarfile}commons-compress-1.21.jar:${securityjarfile}reflections-0.10.2.jar:${securityjarfile}commons-httpclient-3.1.jar:${securityjarfile}xercesImpl-2.12.2.jar:${securityjarfile}nashorn-core-15.3.jar:${securityjarfile}activation-1.1.1.jar:${securityjarfile}mail-1.5.0-b01.jar:${securityjarfile}bcpkix-jdk15on-1.70.jar:${securityjarfile}bctls-jdk15on-1.70.jar:${securityjarfile}bcutil-jdk15on-1.70.jar:${securityjarfile}aws-java-sdk-core-1.12.439.jar:${securityjarfile}junit-dataprovider-1.13.1.jar:${securityjarfile}javax.servlet-api-4.0.1.jar:${securityjarfile}spring-test-5.3.26.jar

        utils_class_name=("com.cloud.utils.backoff.impl.ConstantTimeBackoffTest" "com.cloud.utils.compression.CompressionUtilTest" "com.cloud.utils.crypt.EncryptionSecretKeyCheckerTest" "com.cloud.utils.crypto.EncryptionSecretKeyCheckerTest" "com.cloud.utils.crypto.RSAHelperTest" "com.cloud.utils.encoding.UrlEncoderTest" "com.cloud.utils.exception.ExceptionUtilTest" "com.cloud.utils.net.Ip4AddressTest" "com.cloud.utils.net.IpTest" "com.cloud.utils.net.MacAddressTest" "com.cloud.utils.net.NetUtilsTest" "com.cloud.utils.rest.BasicRestClientTest" "com.cloud.utils.rest.HttpClientHelperTest" "com.cloud.utils.rest.HttpStatusCodeHelperTest" "com.cloud.utils.rest.HttpUriRequestBuilderTest" "com.cloud.utils.rest.RESTServiceConnectorTest" "com.cloud.utils.security.SSLUtilsTest" "com.cloud.utils.ssh.SshHelperTest" "com.cloud.utils.ssh.SSHKeysHelperTest" "com.cloud.utils.storage.QCOW2UtilsTest" "com.cloud.utils.testcase.NioTest" "com.cloud.utils.validation.ChecksumUtilTest" "com.cloud.utils.xmlobject.TestXmlObject" "com.cloud.utils.xmlobject.TestXmlObject2" "com.cloud.utils.DateUtilTest" "com.cloud.utils.FileUtilTest" "com.cloud.utils.HttpUtilsTest" "com.cloud.utils.HumanReadableJsonTest" "com.cloud.utils.LogUtilsTest" "com.cloud.utils.NumbersUtilTest" "com.cloud.utils.PasswordGeneratorTest" "com.cloud.utils.ProcessUtilTest" "com.cloud.utils.PropertiesUtilsTest" "com.cloud.utils.ReflectUtilTest" "com.cloud.utils.ScriptTest" "com.cloud.utils.StringUtilsTest" "com.cloud.utils.SwiftUtilTest" "com.cloud.utils.TernaryTest" "com.cloud.utils.TestProfiler" "com.cloud.utils.UriUtilsParametrizedTest" "com.cloud.utils.UriUtilsTest" "com.cloud.utils.UuidUtilsTest" "org.apache.cloudstack.utils.bytescale.ByteScaleUtilsTest" "org.apache.cloudstack.utils.hypervisor.HypervisorUtilsTest" "org.apache.cloudstack.utils.imagestore.ImageStoreUtilTest" "org.apache.cloudstack.utils.jsinterpreter.JsInterpreterTest" "org.apache.cloudstack.utils.mailing.SMTPMailSenderTest" "org.apache.cloudstack.utils.process.ProcessTest" "org.apache.cloudstack.utils.redfish.RedfishClientTest" "org.apache.cloudstack.utils.reflectiontostringbuilderutils.ReflectionToStringBuilderUtilsTest" "org.apache.cloudstack.utils.security.CertUtilsTest" "org.apache.cloudstack.utils.security.DigestHelperTest" "org.apache.cloudstack.utils.security.ParserUtilsTest" "org.apache.cloudstack.utils.volume.VirtualMachineDiskInfoTest" "org.apache.cloudstack.utils.CloudStackVersionTest")

        for i in  "${utils_class_name[@]}"
        do
            utils_class=$(echo $i)
            utils_result=$(java -classpath $utils_cmd org.junit.runner.JUnitCore $utils_class | grep -i OK) > /dev/null 2>&1
            if [ -n "$utils_result" ]; then
                echo "$utils_class,true" > /dev/null 2>&1
            else
                echo "$utils_class,false" > /dev/null 2>&1
                failed_files+="$utils_class, "
            fi
        done

        # api 75 count
        api_cmd=${securityjarfile}junit-4.13.2.jar:${securityjarfile}hamcrest-all-1.3.jar:${securityjarfile}cloudstack-utils.jar:${securityjarfile}cloudstack-api-test.jar:${securityjarfile}cloudstack-api.jar:${securityjarfile}commons-lang3-3.11.jar:${securityjarfile}commons-collections-3.2.2.jar:${securityjarfile}log4j-api-2.23.1.jar:${securityjarfile}guava-31.1-jre.jar:${securityjarfile}mockito-core-3.12.4.jar:${securityjarfile}byte-buddy-1.10.5.jar:${securityjarfile}cloudstack-framework-config.jar:${securityjarfile}spring-test-5.3.26.jar:${securityjarfile}commons-logging-1.2.jar:${securityjarfile}spring-core-5.3.26.jar:${securityjarfile}cloudstack-framework-direct-download.jar:${securityjarfile}cloudstack-framework-managed-context.jar:${securityjarfile}xercesImpl-2.12.2.jar:${securityjarfile}commons-lang-2.6.jar:${securityjarfile}java-ipv6-0.17.jar:${securityjarfile}objenesis-3.2.jar:${securityjarfile}commons-collections4-4.4.jar

        api_class_name=("com.cloud.agent.api.storage.OVFHelperTest" "com.cloud.agent.api.to.LoadBalancerTOTest" "com.cloud.deploy.DataCenterDeploymentTest" "com.cloud.host.ControlStateTest" "com.cloud.network.as.AutoScalePolicyTest" "com.cloud.network.as.AutoScaleVmGroupTest" "com.cloud.network.router.VirtualRouterAutoScaleTest" "com.cloud.network.IsolationMethodTest" "com.cloud.network.NetworksTest" "com.cloud.storage.StorageTest" "com.cloud.user.AccountTypeTest" "org.apache.cloudstack.acl.RoleTypeTest" "org.apache.cloudstack.acl.RuleTest" "org.apache.cloudstack.api.command.admin.account.CreateAccountCmdTest" "org.apache.cloudstack.api.command.admin.annotation.AddAnnotationCmdTest" "org.apache.cloudstack.api.command.admin.offering.CreateDiskOfferingCmdTest" "org.apache.cloudstack.api.command.admin.offering.CreateNetworkOfferingCmdTest" "org.apache.cloudstack.api.command.admin.offering.CreateServiceOfferingCmdTest" "org.apache.cloudstack.api.command.admin.storage.CreateSecondaryStagingStoreCmdTest" "org.apache.cloudstack.api.command.admin.storage.FindStoragePoolsForMigrationCmdTest" "org.apache.cloudstack.api.command.admin.systemvm.PatchSystemVMCmdTest" "org.apache.cloudstack.api.command.admin.user.CreateUserCmdTest" "org.apache.cloudstack.api.command.admin.vlan.UpdateVlanIpRangeCmdTest" "org.apache.cloudstack.api.command.admin.vm.MigrateVirtualMachineWithVolumeCmdTest" "org.apache.cloudstack.api.command.admin.vpc.CreateVPCOfferingCmdTest" "org.apache.cloudstack.api.command.admin.zone.CreateZoneCmdTest" "org.apache.cloudstack.api.command.test.ActivateProjectCmdTest" "org.apache.cloudstack.api.command.test.AddAccountToProjectCmdTest" "org.apache.cloudstack.api.command.test.AddClusterCmdTest" "org.apache.cloudstack.api.command.test.AddHostCmdTest" "org.apache.cloudstack.api.command.test.AddIpToVmNicTest" "org.apache.cloudstack.api.command.test.AddNetworkServiceProviderCmdTest" "org.apache.cloudstack.api.command.test.AddSecondaryStorageCmdTest" "org.apache.cloudstack.api.command.test.AddVpnUserCmdTest" "org.apache.cloudstack.api.command.test.CreateAutoScaleVmProfileCmdTest" "org.apache.cloudstack.api.command.test.CreateRoleCmdTest" "org.apache.cloudstack.api.command.test.CreateSnapshotCmdTest" "org.apache.cloudstack.api.command.test.ImportRoleCmdTest" "org.apache.cloudstack.api.command.test.ListCfgCmdTest" "org.apache.cloudstack.api.command.test.RegionCmdTest" "org.apache.cloudstack.api.command.test.ResetVMUserDataCmdTest" "org.apache.cloudstack.api.command.test.ScaleVMCmdTest" "org.apache.cloudstack.api.command.test.UpdateAutoScaleVmProfileCmdTest" "org.apache.cloudstack.api.command.test.UpdateCfgCmdTest" "org.apache.cloudstack.api.command.test.UpdateConditionCmdTest" "org.apache.cloudstack.api.command.test.UpdateHostPasswordCmdTest" "org.apache.cloudstack.api.command.test.UpdateRoleCmdTest" "org.apache.cloudstack.api.command.test.UpdateVmNicIpTest" "org.apache.cloudstack.api.command.test.UsageCmdTest" "org.apache.cloudstack.api.command.user.firewall.CreateEgressFirewallRuleCmdTest" "org.apache.cloudstack.api.command.user.iso.RegisterIsoCmdTest" "org.apache.cloudstack.api.command.user.network.CreateNetworkCmdTest" "org.apache.cloudstack.api.command.user.network.UpdateNetworkCmdTest" "org.apache.cloudstack.api.command.user.project.CreateProjectCmdTest" "org.apache.cloudstack.api.command.user.snapshot.CreateSnapshotPolicyCmdTest" "org.apache.cloudstack.api.command.user.template.CopyTemplateCmdByAdminTest" "org.apache.cloudstack.api.command.user.template.CopyTemplateCmdTest" "org.apache.cloudstack.api.command.user.template.RegisterTemplateCmdByAdminTest" "org.apache.cloudstack.api.command.user.template.RegisterTemplateCmdTest" "org.apache.cloudstack.api.command.user.userdata.DeleteUserDataCmdTest" "org.apache.cloudstack.api.command.user.userdata.LinkUserDataToTemplateCmdTest" "org.apache.cloudstack.api.command.user.userdata.ListUserDataCmdTest" "org.apache.cloudstack.api.command.user.userdata.RegisterUserDataCmdTest" "org.apache.cloudstack.api.command.user.vm.CreateVMScheduleCmdTest" "org.apache.cloudstack.api.command.user.vm.DeleteVMScheduleCmdTest" "org.apache.cloudstack.api.command.user.vm.ListVMScheduleCmdTest" "org.apache.cloudstack.api.command.user.vm.UpdateVMScheduleCmdTest" "org.apache.cloudstack.api.command.user.vpc.CreateVPCCmdTest" "org.apache.cloudstack.api.command.user.vpc.UpdateVPCCmdTest" "org.apache.cloudstack.api.response.HostResponseTest" "org.apache.cloudstack.api.response.StatsResponseTest" "org.apache.cloudstack.api.ApiCommandResourceTypeTest" "org.apache.cloudstack.api.BaseCmdTest" "org.apache.cloudstack.context.CallContextTest" "org.apache.cloudstack.usage.UsageUnitTypesTest")

        for i in  "${api_class_name[@]}"
        do
            api_class=$(echo $i)
            api_result=$(java -classpath $api_cmd org.junit.runner.JUnitCore $api_class | grep -i OK) > /dev/null 2>&1
            if [ -n "$api_result" ]; then
                echo "$api_class,true" > /dev/null 2>&1
            else
                echo "$api_class,false" > /dev/null 2>&1
                failed_files+="$api_class, "
            fi
        done

        # framework 29 count
        fw_cmd=${securityjarfile}junit-4.13.2.jar:${securityjarfile}hamcrest-all-1.3.jar:${securityjarfile}cloudstack-utils.jar:${securityjarfile}cloudstack-framework-cluster.jar:${securityjarfile}cloudstack-framework-cluster-test.jar:${securityjarfile}mockito-core-3.12.4.jar:${securityjarfile}byte-buddy-1.10.5.jar:${securityjarfile}cloudstack-framework-db.jar:${securityjarfile}cloudstack-framework-config.jar:${securityjarfile}cloudstack-api.jar:${securityjarfile}objenesis-3.2.jar:${securityjarfile}httpcore-4.4.16.jar:${securityjarfile}cloudstack-framework-config-test.jar:${securityjarfile}commons-lang-2.6.jar:${securityjarfile}guava-testlib-18.0.jar:${securityjarfile}guava-31.1-jre.jar:${securityjarfile}cloudstack-framework-db-test.jar:${securityjarfile}gson-1.7.2.jar:${securityjarfile}cloudstack-engine-schema.jar:${securityjarfile}cloudstack-engine-api.jar:${securityjarfile}commons-configuration-1.10.jar:${securityjarfile}spring-test-5.3.26.jar:${securityjarfile}commons-logging-1.2.jar:${securityjarfile}spring-core-5.3.26.jar:${securityjarfile}reflections-0.10.2.jar:${securityjarfile}cglib-nodep-3.3.0.jar:${securityjarfile}javax.persistence-2.2.1.jar:${securityjarfile}commons-lang3-3.11.jar:${securityjarfile}cloudstack-framework-ipc-test.jar:${securityjarfile}cloudstack-framework-ipc.jar:${securityjarfile}cloudstack-framework-jobs.jar:${securityjarfile}cloudstack-framework-jobs-test.jar:${securityjarfile}cloudstack-framework-managed-context.jar:${securityjarfile}cloudstack-framework-managed-context-test.jar:${securityjarfile}cloudstack-framework-quota-test.jar:${securityjarfile}cloudstack-framework-quota.jar:${securityjarfile}mail-1.5.0-b01.jar:${securityjarfile}commons-dbcp2-2.9.0.jar:${securityjarfile}commons-pool2-2.9.0.jar:${securityjarfile}commons-collections-3.2.2.jar:${securityjarfile}cloudstack-usage.jar:${securityjarfile}nashorn-core-15.3.jar:${securityjarfile}jackson-core-2.13.3.jar:${securityjarfile}jackson-databind-2.13.3.jar:${securityjarfile}jackson-module-jaxb-annotations-2.13.3.jar:${securityjarfile}cloudstack-framework-rest-test.jar:${securityjarfile}cloudstack-framework-rest.jar:${securityjarfile}cloudstack-framework-spring-module-test.jar:${securityjarfile}cloudstack-framework-spring-module.jar:${securityjarfile}spring-beans-5.3.26.jar:${securityjarfile}spring-context-5.3.26.jar:${securityjarfile}log4j-api-2.23.1.jar:${securityjarfile}spring-expression-5.3.26.jar:${securityjarfile}spring-aop-5.3.26.jar:${securityjarfile}commons-logging-1.2.jar:${securityjarfile}commons-io-2.8.0.jar

        fw_class_name=("com.cloud.cluster.ClusterServiceServletAdapterTest" "org.apache.cloudstack.framework.config.impl.ConfigDepotAdminTest" "org.apache.cloudstack.framework.config.impl.ConfigDepotImplTest" "org.apache.cloudstack.framework.config.ConfigKeyTest" "com.cloud.utils.crypt.EncryptionSecretKeyChangerTest" "com.cloud.utils.db.ElementCollectionTest" "com.cloud.utils.db.FilterTest" "com.cloud.utils.db.GenericDaoBaseTest" "org.apache.cloudstack.framework.jobs.AsyncJobManagerTest" "org.apache.cloudstack.managed.context.impl.DefaultManagedContextTest" "org.apache.cloudstack.quota.activationrule.presetvariables.AccountTest" "org.apache.cloudstack.quota.activationrule.presetvariables.BackupOfferingTest" "org.apache.cloudstack.quota.activationrule.presetvariables.ComputeOfferingTest" "org.apache.cloudstack.quota.activationrule.presetvariables.ComputingResourcesTest" "org.apache.cloudstack.quota.activationrule.presetvariables.DomainTest" "org.apache.cloudstack.quota.activationrule.presetvariables.GenericPresetVariableTest" "org.apache.cloudstack.quota.activationrule.presetvariables.HostTest" "org.apache.cloudstack.quota.activationrule.presetvariables.PresetVariableHelperTest" "org.apache.cloudstack.quota.activationrule.presetvariables.ResourceTest" "org.apache.cloudstack.quota.activationrule.presetvariables.RoleTest" "org.apache.cloudstack.quota.activationrule.presetvariables.StorageTest" "org.apache.cloudstack.quota.activationrule.presetvariables.ValueTest" "org.apache.cloudstack.quota.constant.QuotaTypesTest" "org.apache.cloudstack.quota.vo.QuotaTariffVOTest" "org.apache.cloudstack.quota.QuotaManagerImplTest" "org.apache.cloudstack.framework.ws.jackson.CSJacksonAnnotationTest" "org.apache.cloudstack.spring.module.factory.ModuleBasedContextFactoryTest" "org.apache.cloudstack.spring.module.locator.impl.ClasspathModuleDefinitionSetLocatorTest" "org.apache.cloudstack.spring.module.model.impl.DefaultModuleDefinitionTest")

        for i in  "${fw_class_name[@]}"
        do
            fw_class=$(echo $i)
            fw_result=$(java -classpath $fw_cmd org.junit.runner.JUnitCore $fw_class | grep -i OK) > /dev/null 2>&1
            if [ -n "$fw_result" ]; then
                echo "$fw_class,true" > /dev/null 2>&1
            else
                echo "$fw_class,false" > /dev/null 2>&1
                failed_files+="$fw_class, "
            fi
        done

        # scripts 112 count
        script_cmds=("$scriptpath/installer/createtmplt.sh" "$scriptpath/installer/createvolume.sh" "$scriptpath/installer/export-templates.sh" "$scriptpath/installer/installcentos.sh" "$scriptpath/installer/installdomp.sh" "$scriptpath/installer/run_installer.sh" "$scriptpath/network/domr/router_proxy.sh" "$scriptpath/network/exdhcp/dhcpd_edithosts.py" "$scriptpath/network/exdhcp/dnsmasq_edithosts.sh" "$scriptpath/network/exdhcp/prepare_dhcpd.sh" "$scriptpath/network/exdhcp/prepare_dnsmasq.sh" "$scriptpath/network/ping/baremetal_user_data.py" "$scriptpath/network/ping/prepare_kickstart_bootfile.py" "$scriptpath/network/ping/prepare_kickstart_kernel_initrd.py" "$scriptpath/network/ping/prepare_tftp_bootfile.py" "$scriptpath/storage/checkchildren.sh" "$scriptpath/storage/installIso.sh" "$scriptpath/storage/qcow2/create_private_template.sh" "$scriptpath/storage/qcow2/createtmplt.sh" "$scriptpath/storage/qcow2/createvm.sh" "$scriptpath/storage/qcow2/createvolume.sh" "$scriptpath/storage/qcow2/delvm.sh" "$scriptpath/storage/qcow2/get_domr_kernel.sh" "$scriptpath/storage/qcow2/get_iqn.sh" "$scriptpath/storage/qcow2/importmpl.sh" "$scriptpath/storage/qcow2/listvmdisk.sh" "$scriptpath/storage/qcow2/listvmdisksize.sh" "$scriptpath/storage/qcow2/listvmtmplt.sh" "$scriptpath/storage/qcow2/listvolume.sh" "$scriptpath/storage/qcow2/managesnapshot.sh" "$scriptpath/storage/qcow2/managevolume.sh" "$scriptpath/storage/qcow2/resizevolume.sh" "$scriptpath/storage/secondary/cloud-install-sys-tmplt.py" "$scriptpath/storage/secondary/create_privatetemplate_from_snapshot_xen.sh" "$scriptpath/storage/secondary/createtmplt.sh" "$scriptpath/storage/secondary/createvolume.sh" "$scriptpath/storage/secondary/installIso.sh" "$scriptpath/storage/secondary/listvmtmplt.sh" "$scriptpath/storage/secondary/listvolume.sh" "$scriptpath/util/create-kubernetes-binaries-iso.sh" "$scriptpath/util/ipmi.py" "$scriptpath/util/macgen.py" "$scriptpath/util/migrate-dynamicroles.py" "$scriptpath/util/prepare_linmin.sh" "$scriptpath/vm/hypervisor/kvm/kvmheartbeat_clvm.sh" "$scriptpath/vm/hypervisor/kvm/kvmheartbeat_rbd.py" "$scriptpath/vm/hypervisor/kvm/kvmheartbeat_rbd.sh" "$scriptpath/vm/hypervisor/kvm/kvmheartbeat.sh" "$scriptpath/vm/hypervisor/kvm/kvmvmactivity_clvm.sh" "$scriptpath/vm/hypervisor/kvm/kvmvmactivity_rbd.py" "$scriptpath/vm/hypervisor/kvm/kvmvmactivity_rbd.sh" "$scriptpath/vm/hypervisor/kvm/kvmvmactivity.sh" "$scriptpath/vm/hypervisor/kvm/nsrkvmbackup.sh" "$scriptpath/vm/hypervisor/kvm/nsrkvmrestore.sh" "$scriptpath/vm/hypervisor/kvm/patch.sh" "$scriptpath/vm/hypervisor/kvm/setup_agent.sh" "$scriptpath/vm/hypervisor/ovm3/cloudstack.py" "$scriptpath/vm/hypervisor/ovm3/storagehealth.py" "$scriptpath/vm/hypervisor/update_host_passwd.sh" "$scriptpath/vm/hypervisor/versions.sh" "$scriptpath/vm/hypervisor/vmware/discover_networks.py" "$scriptpath/vm/hypervisor/xenserver/add_to_vcpus_params_live.sh" "$scriptpath/vm/hypervisor/xenserver/check_heartbeat.sh" "$scriptpath/vm/hypervisor/xenserver/cloud-clean-vlan.sh" "$scriptpath/vm/hypervisor/xenserver/cloud-prepare-upgrade.sh" "$scriptpath/vm/hypervisor/xenserver/cloud-propagate-vlan.sh" "$scriptpath/vm/hypervisor/xenserver/cloud-setup-bonding.sh" "$scriptpath/vm/hypervisor/xenserver/cloudstack_pluginlib.py" "$scriptpath/vm/hypervisor/xenserver/copy_vhd_from_secondarystorage.sh" "$scriptpath/vm/hypervisor/xenserver/copy_vhd_to_secondarystorage.sh" "$scriptpath/vm/hypervisor/xenserver/create_privatetemplate_from_snapshot.sh" "$scriptpath/vm/hypervisor/xenserver/kill_copy_process.sh" "$scriptpath/vm/hypervisor/xenserver/launch_hb.sh" "$scriptpath/vm/hypervisor/xenserver/make_migratable.sh" "$scriptpath/vm/hypervisor/xenserver/mockxcpplugin.py" "$scriptpath/vm/hypervisor/xenserver/network_info.sh" "$scriptpath/vm/hypervisor/xenserver/ovs-get-bridge.sh" "$scriptpath/vm/hypervisor/xenserver/ovs-get-dhcp-iface.sh" "$scriptpath/vm/hypervisor/xenserver/ovs-vif-flows.py" "$scriptpath/vm/hypervisor/xenserver/perfmon.py" "$scriptpath/vm/hypervisor/xenserver/setup_heartbeat_file.sh" "$scriptpath/vm/hypervisor/xenserver/setup_heartbeat_sr.sh" "$scriptpath/vm/hypervisor/xenserver/setup_iscsi.sh" "$scriptpath/vm/hypervisor/xenserver/setupxenserver.sh" "$scriptpath/vm/hypervisor/xenserver/upgrade_snapshot.sh" "$scriptpath/vm/hypervisor/xenserver/upgrade_vnc_config.sh" "$scriptpath/vm/hypervisor/xenserver/xcposs/NFSSR.py" "$scriptpath/vm/hypervisor/xenserver/xcpserver/NFSSR.py" "$scriptpath/vm/hypervisor/xenserver/xenheartbeat.sh" "$scriptpath/vm/hypervisor/xenserver/xenserver56/InterfaceReconfigure.py" "$scriptpath/vm/hypervisor/xenserver/xenserver56/NFSSR.py" "$scriptpath/vm/hypervisor/xenserver/xenserver56fp1/NFSSR.py" "$scriptpath/vm/hypervisor/xenserver/xenserver60/NFSSR.py" "$scriptpath/vm/hypervisor/xenserver/xs_cleanup.sh" "$scriptpath/vm/network/ovs-pvlan-cleanup.sh" "$scriptpath/vm/network/ovs-pvlan-dhcp-host.sh" "$scriptpath/vm/network/ovs-pvlan-kvm-dhcp-host.sh" "$scriptpath/vm/network/ovs-pvlan-kvm-vm.sh" "$scriptpath/vm/network/ovs-pvlan-vm.sh" "$scriptpath/vm/network/security_group.py" "$scriptpath/vm/network/tungsten/create_tap_device.sh" "$scriptpath/vm/network/tungsten/delete_tap_device.sh" "$scriptpath/vm/network/tungsten/setup_tungsten_vrouter.sh" "$scriptpath/vm/network/tungsten/update_tungsten_loadbalancer_ssl.sh" "$scriptpath/vm/network/tungsten/update_tungsten_loadbalancer_stats.sh" "$scriptpath/vm/network/vnet/cloudstack_pluginlib.py" "$scriptpath/vm/network/vnet/modifyvlan.sh" "$scriptpath/vm/network/vnet/modifyvxlan.sh" "$scriptpath/vm/network/vnet/ovstunnel.py" "$scriptpath/vm/pingtest.sh" "$scriptpath/vm/systemvm/injectkeys.py" "$scriptpath/vm/systemvm/injectkeys.sh")

        for i in  "${script_cmds[@]}"
        do
            utils_cmd=$(echo $i)
            UTILS_RESULT=$($utils_cmd 2>&1)
            case "${UTILS_RESULT,,}" in
                    *usage* | *syntax* | *print* | *device* \
                            | *type* | *cloud* | *xe* | *ovs* \
                            | *operation* | *find* | *host* \
                    )
                            echo "$utils_cmd,true" > /dev/null 2>&1
                            ;;
                    *)
                            echo "$utils_cmd,false" > /dev/null 2>&1
                            failed_files+="$utils_cmd, "
                            ;;
            esac

        done

        # process check
        count1=$(systemctl status mold-monitoring.service | grep -i SUCCESS | wc -l) > /dev/null 2>&1
        if [ "$count1" -eq 0 ]; then
            echo "monitoring.service,false" > /dev/null 2>&1
            failed_files+="monitoring.service, "
        else
            echo "monitoring.service,true" > /dev/null 2>&1
        fi
        count2=$(systemctl status cloudstack-management.service | grep -i running | wc -l) > /dev/null 2>&1
        if [ "$count2" -eq 0 ]; then
            echo "mold.service,false" > /dev/null 2>&1
            failed_files+="mold.service, "
        else
            echo "mold.service,true" > /dev/null 2>&1
        fi

        failed_files="${failed_files%, }"

        # 감사기록 생성
        if [ ! -n "$failed_files" ]; then
            mysql --user=root --password=$DATABASE_PASSWD -e "use cloud; INSERT INTO security_check (mshost_id, check_result, check_date, check_failed_list, type) VALUES ('1', '1', DATE_SUB(NOW(), INTERVAL 9 HOUR), '$failed_files', 'Initial')"  > /dev/null 2>&1
            UUID=$(cat /proc/sys/kernel/random/uuid)
            mysql --user=root --password=$DATABASE_PASSWD -e "use cloud; INSERT INTO event (uuid, type, state, description, user_id, account_id, domain_id, resource_id, created, level, start_id, archived, display, client_ip) VALUES ('$UUID', 'SECURITY.CHECK', 'Completed', 'Successfully completed security check on the management server when operating the product.', '2', '2', '1', '0', DATE_SUB(NOW(), INTERVAL 9 HOUR), 'INFO', '0', '0', '1', '$HOST_IP');" > /dev/null 2>&1
        else
            mysql --user=root --password=$DATABASE_PASSWD -e "use cloud; INSERT INTO security_check (mshost_id, check_result, check_date, check_failed_list, type) VALUES ('1', '0', DATE_SUB(NOW(), INTERVAL 9 HOUR), '$failed_files', 'Initial')"  > /dev/null 2>&1
            UUID=$(cat /proc/sys/kernel/random/uuid)
            mysql --user=root --password=$DATABASE_PASSWD -e "use cloud; INSERT INTO alert (uuid, type, pod_id, data_center_id, subject, sent_count, created, last_sent, archived, name) VALUES ('$UUID', '14', '0', '0', 'Management server node security check failed when operating the product.', '1', DATE_SUB(NOW(), INTERVAL 9 HOUR), DATE_SUB(NOW(), INTERVAL 9 HOUR), '0', 'ALERT.MANAGEMENT');" > /dev/null 2>&1
            UUID=$(cat /proc/sys/kernel/random/uuid)
            mysql --user=root --password=$DATABASE_PASSWD -e "use cloud; INSERT INTO event (uuid, type, state, description, user_id, account_id, domain_id, resource_id, created, level, start_id, archived, display, client_ip) VALUES ('$UUID', 'SECURITY.CHECK', 'Completed', 'Failed to execute security check on the management server when operating the product.', '2', '2', '1', '0', DATE_SUB(NOW(), INTERVAL 9 HOUR), 'INFO', '0', '0', '1', '$HOST_IP');" > /dev/null 2>&1
        fi
        mysql --user=root --password=$DATABASE_PASSWD -e "use cloud; SET GLOBAL foreign_key_checks=1;" > /dev/null 2>&1
    fi
}

function removeVariable()
{
    for var in {1..5} ; do echo 01010101 > /etc/cloudstack/management/db.properties ; done
    rm -rf /etc/cloudstack/management/db.properties

    # override variable to 0 and 1
    for var in {1..5}
    do 
        key=01010101
        DbCloudEncPassword=01010101
        DATABASE_PASSWD=01010101
    done
}

if [ "$oper" == "start" ]; then
    beforeStart
    systemctl start cloudstack-management
    systemctl start mold-monitoring
    # 자체시험 실패 테스트 케이스
    # systemctl stop cloudstack-management
    securityCheck
    removeVariable
    afterStarted
elif [ "$oper" == "restart" ]; then
    beforeStart
    systemctl restart cloudstack-management
    systemctl restart mold-monitoring
    afterStarted
elif [ "$oper" == "stop" ]; then
    systemctl stop cloudstack-management
    systemctl stop mold-monitoring
else
    echo "Please enter the parameter value (start, stop, restart)"
    exit 0
fi


# override variable to 0 and 1
for var in {1..5}
do 
    kek_pass=01010101
done
